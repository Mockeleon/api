name: Deploy to Production

on:
  push:
    branches: ['main'] # Deploy when code is pushed or merged into main
  workflow_run:
    workflows: ['CI Tests'] # Wait for CI workflow to complete
    types:
      - completed
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  deploy:
    # Conditions:
    # - Run if this is a direct push to main, OR
    # - Run if CI Tests finished successfully on main
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    name: Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.3.0'
          cache: 'npm'

      - name: Install dependencies and build
        run: |
          npm ci
          npm run build

      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          API_DEPLOY_PATH: ${{ secrets.API_DEPLOY_PATH }}
        run: |
          set -e

          # --- Setup SSH ---
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts

          # --- Sync build files ---
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.env' \
            --exclude 'logs' \
            ./dist/ "$SERVER_USER@$SERVER_HOST:$API_DEPLOY_PATH/dist/"

          # --- Sync configs ---
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ecosystem.config.cjs package*.json "$SERVER_USER@$SERVER_HOST:$API_DEPLOY_PATH/"

          # --- Restart PM2 and run health checks ---
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" << 'ENDSSH'
            set -e
            cd ${{ secrets.API_DEPLOY_PATH }}

            npm ci --omit=dev

            pm2 delete mockeleon-api-4000 || true
            pm2 delete mockeleon-api-4001 || true
            pm2 delete mockeleon-api-4002 || true
            pm2 delete mockeleon-api-4003 || true

            pm2 start ecosystem.config.cjs
            pm2 save

            # Verify all instances are healthy
            for port in 4000 4001 4002 4003; do
              if ! curl -fs http://127.0.0.1:\$port/health >/dev/null; then
                echo "Health check failed on port \$port"
                pm2 logs --nostream --lines=30
                exit 1
              else
                echo "Port \$port healthy"
              fi
            done
          ENDSSH

          rm -f ~/.ssh/deploy_key
